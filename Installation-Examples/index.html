
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A docs test">
      
      
      
        <meta name="author" content="Docker Mailserver">
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.1">
    
    
      
        <title>Installation Examples - Test docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1655a90d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.7fa14f5b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-a-simple-mailserver" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Test docs" class="md-header__button md-logo" aria-label="Test docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Test docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installation Examples
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/docker-mailserver/docker-mailserver/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    docker-mailserver/docker-mailserver
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Test docs" class="md-nav__button md-logo" aria-label="Test docs">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Test docs
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/docker-mailserver/docker-mailserver/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    docker-mailserver/docker-mailserver
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        demoghp
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-AWS-SES/" class="md-nav__link">
        Configure AWS SES
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-Accounts/" class="md-nav__link">
        Configure Accounts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-Aliases/" class="md-nav__link">
        Configure Aliases
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-DKIM/" class="md-nav__link">
        Configure DKIM
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-DMARC/" class="md-nav__link">
        Configure DMARC
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-Fail2ban/" class="md-nav__link">
        Configure Fail2ban
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-LDAP/" class="md-nav__link">
        Configure LDAP
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-POP3/" class="md-nav__link">
        Configure POP3
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-Relay-Hosts/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-SPF/" class="md-nav__link">
        Configure SPF
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-SSL/" class="md-nav__link">
        Configure SSL
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-Sieve-filters/" class="md-nav__link">
        Configure Sieve filters
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Configure-autodiscover/" class="md-nav__link">
        Configure autodiscover
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../FAQ-and-Tips/" class="md-nav__link">
        FAQ and Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Forward-Only-mailserver-with-LDAP-authentication/" class="md-nav__link">
        Forward Only mailserver with LDAP authentication
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Full-text-search/" class="md-nav__link">
        Full text search
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Home/" class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../IPv6/" class="md-nav__link">
        IPv6
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Installation Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Installation Examples
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-a-simple-mailserver" class="md-nav__link">
    Building a simple mailserver
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-docker-mailserver-behind-proxy" class="md-nav__link">
    Using docker-mailserver behind proxy
  </a>
  
    <nav class="md-nav" aria-label="Using docker-mailserver behind proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#information" class="md-nav__link">
    Information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-of-the-used-proxy-software" class="md-nav__link">
    Configuration of the used proxy software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-of-the-backend-dovecot-and-postfix" class="md-nav__link">
    Configuration of the backend (dovecot and postfix)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../List-of-optional-config-files-%26-directories/" class="md-nav__link">
        List of optional config files & directories
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Override-Default-Dovecot-Configuration/" class="md-nav__link">
        Add configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Override-Default-Postfix-Configuration/" class="md-nav__link">
        Override Default Postfix Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Retrieve-emails-from-a-remote-mail-server-%28using-builtin-fetchmail%29/" class="md-nav__link">
        Retrieve emails from a remote mail server (using builtin fetchmail)
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Understanding-the-ports/" class="md-nav__link">
        Understanding the ports
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Update-and-cleanup/" class="md-nav__link">
        Update and cleanup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Using-in-Kubernetes/" class="md-nav__link">
        Using in Kubernetes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../_Footer/" class="md-nav__link">
         Footer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../_Sidebar/" class="md-nav__link">
         Sidebar
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../setup.sh/" class="md-nav__link">
        Setup.sh
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-a-simple-mailserver" class="md-nav__link">
    Building a simple mailserver
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-docker-mailserver-behind-proxy" class="md-nav__link">
    Using docker-mailserver behind proxy
  </a>
  
    <nav class="md-nav" aria-label="Using docker-mailserver behind proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#information" class="md-nav__link">
    Information
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-of-the-used-proxy-software" class="md-nav__link">
    Configuration of the used proxy software
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-of-the-backend-dovecot-and-postfix" class="md-nav__link">
    Configuration of the backend (dovecot and postfix)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/docker-mailserver/docker-mailserver/edit/master/docs/Installation-Examples.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Installation Examples</h1>
                
                <h2 id="building-a-simple-mailserver">Building a simple mailserver</h2>
<p><strong>WARNING</strong>: Adding the docker network's gateway to the list of trusted hosts, e.g. using the <code>network</code> or <code>connected-networks</code> option, can create an <a href="https://en.wikipedia.org/wiki/Open_mail_relay"><strong>open relay</strong></a>, <a href="https://github.com/tomav/docker-mailserver/issues/1405#issuecomment-590106498">for instance</a> if IPv6 is enabled on the host machine but not in Docker. (<a href="https://github.com/tomav/docker-mailserver/issues/1405">#1405</a>)</p>
<p>We are going to use this docker based mailserver:</p>
<ul>
<li>First create a directory for the mailserver and get the setup script:
  ```
  mkdir -p /var/ds/mail.example.org
  cd /var/ds/mail.example.org/</li>
</ul>
<p>curl -o setup.sh \
      https://raw.githubusercontent.com/tomav/docker-mailserver/master/setup.sh
  chmod a+x ./setup.sh
  ```</p>
<ul>
<li>Create the file <code>docker-compose.yml</code> with a content like this:
  ```
  version: '2'</li>
</ul>
<p>services:
    mail:
      image: tvial/docker-mailserver:latest
      hostname: mail
      domainname: example.org
      container_name: mail
      ports:
      - "25:25"
      - "587:587"
      - "465:465"
      volumes:
      - ./data/:/var/mail/
      - ./state/:/var/mail-state/
      - ./config/:/tmp/docker-mailserver/
      - /var/ds/wsproxy/letsencrypt/:/etc/letsencrypt/
      environment:
      - PERMIT_DOCKER=network
      - SSL_TYPE=letsencrypt
      - ONE_DIR=1
      - DMS_DEBUG=1
      - SPOOF_PROTECTION=0
      - REPORT_RECIPIENT=1
      - ENABLE_SPAMASSASSIN=0
      - ENABLE_CLAMAV=0
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=0
      cap_add:
      - NET_ADMIN
      - SYS_PTRACE
  ```</p>
<p>For more details about the environment variables that can be used,
  and their meaning and possible values, check also these:
  - https://github.com/tomav/docker-mailserver#environment-variables
  - https://github.com/tomav/docker-mailserver/blob/master/.env.dist</p>
<p>Make sure to set the proper <code>domainname</code> that you will use for the
  emails. We forward only SMTP ports (not POP3 and IMAP) because we
  are not interested in accessing the mailserver directly (from a
  client).  We also use these settings:
  - <code>PERMIT_DOCKER=network</code> because we want to send emails from other
    docker containers.
  - <code>SSL_TYPE=letsencrypt</code> because we will manage SSL certificates
    with letsencrypt.</p>
<ul>
<li>
<p>We need to open these ports on the firewall: <code>25</code>, <code>587</code>, <code>465</code>
  <code>ufw allow 25
  ufw allow 587
  ufw allow 465</code>
  On your server you may have to do it differently.</p>
</li>
<li>
<p>Pull the docker image:
  <code>docker pull tvial/docker-mailserver:latest</code></p>
</li>
<li>
<p>Now generate the DKIM keys with <code>./setup.sh config dkim</code> and copy
  the content of the file <code>config/opendkim/keys/domain.tld/mail.txt</code>
  on the domain zone configuration at the DNS server. I use
  <a href="https://github.com/docker-scripts/bind9">bind9</a> for managing my
  domains, so I just paste it on <code>example.org.db</code>:
  ```
  mail._domainkey IN      TXT     ( "v=DKIM1; h=sha256; k=rsa; "
          "p=MIIBIjANBgkqhkiG9w0BAQEFACAQ8AMIIBCgKCAQEAaH5KuPYPSF3Ppkt466BDMAFGOA4mgqn4oPjZ5BbFlYA9l5jU3bgzRj3l6/Q1n5a9lQs5fNZ7A/HtY0aMvs3nGE4oi+LTejt1jblMhV/OfJyRCunQBIGp0s8G9kIUBzyKJpDayk2+KJSJt/lxL9Iiy0DE5hIv62ZPP6AaTdHBAsJosLFeAzuLFHQ6USyQRojefqFQtgYqWQ2JiZQ3"
          "iqq3bD/BVlwKRp5gH6TEYEmx8EBJUuDxrJhkWRUk2VDl1fqhVBy8A9O7Ah+85nMrlOHIFsTaYo9o6+cDJ6t1i6G1gu+bZD0d3/3bqGLPBQV9LyEL1Rona5V7TJBGg099NQkTz1IwIDAQAB" )  ; ----- DKIM key mail for example.org</p>
</li>
</ul>
<p>```</p>
<ul>
<li>Add these configurations as well on the same file on the DNS server:
  ```
  mail      IN  A   10.11.12.13</li>
</ul>
<p>; mailservers for example.org
      3600  IN  MX  1  mail.example.org.</p>
<p>; Add SPF record
            IN TXT "v=spf1 mx ~all"
  ```
  Then don't forget to change the serial number and to restart the service.</p>
<ul>
<li>
<p>Get an SSL certificate from letsencrypt. I use
  <a href="https://github.com/docker-scripts/wsproxy">wsproxy</a> for managing
  SSL letsencrypt certificates of my domains:
  <code>cd /var/ds/wsproxy
  ds domains-add mail mail.example.org
  ds get-ssl-cert myemail@gmail.com mail.example.org --test
  ds get-ssl-cert myemail@gmail.com mail.example.org</code>
  Now the certificates will be available on
  <code>/var/ds/wsproxy/letsencrypt/live/mail.example.org</code>.</p>
</li>
<li>
<p>Start the mailserver and check for any errors:
  <code>apt install docker-compose
  docker-compose up mail</code></p>
</li>
<li>
<p>Create email accounts and aliases with <code>SPOOF_PROTECTION=0</code>:
  <code>./setup.sh email add admin@example.org passwd123
  ./setup.sh email add info@example.org passwd123
  ./setup.sh alias add admin@example.org myemail@gmail.com
  ./setup.sh alias add info@example.org myemail@gmail.com
  ./setup.sh email list
  ./setup.sh alias list</code>
  Aliases make sure that any email that comes to these accounts is
  forwarded to my real email address, so that I don't need to use
  POP3/IMAP in order to get these messages. Also no anti-spam and
  anti-virus software is needed, making the mailserver lighter.</p>
</li>
<li>
<p>Or create email accounts and aliases with <code>SPOOF_PROTECTION=1</code>:
  <code>./setup.sh email add admin.gmail@example.org passwd123
  ./setup.sh email add info.gmail@example.org passwd123
  ./setup.sh alias add admin@example.org admin.gmail@example.org
  ./setup.sh alias add info@example.org info.gmail@example.org
  ./setup.sh alias add admin.gmail@example.org myemail@gmail.com
  ./setup.sh alias add info.gmail@example.org myemail@gmail.com
  ./setup.sh email list
  ./setup.sh alias list</code>
  This extra step is required to avoid the <code>553 5.7.1 Sender address rejected: not owned by user</code> error (the account used for setting up gmail is <code>admin.gmail@example.org</code> and <code>info.gmail@example.org</code> )</p>
</li>
<li>
<p>Send some test emails to these addresses and make other tests. Then
  stop the container with <code>Ctrl+c</code> and start it again as a daemon:
  <code>docker-compose up -d mail</code>.</p>
</li>
<li>
<p>Now save on Moodle configuration the SMTP settings and test by
  trying to send some messages to other users:</p>
</li>
<li><strong>SMTP hosts</strong>: <code>mail.example.org:465</code></li>
<li><strong>SMTP security</strong>: <code>SSL</code></li>
<li><strong>SMTP username</strong>: <code>info@example.org</code></li>
<li><strong>SMTP password</strong>: <code>passwd123</code></li>
</ul>
<h2 id="using-docker-mailserver-behind-proxy">Using docker-mailserver behind proxy</h2>
<h3 id="information">Information</h3>
<p>If you are hiding your container behind a proxy service you might have discovered that the proxied requests from now on contain the proxy IP as the request origin. Whilst this behavior is technical correct it produces certain problems on the containers behind the proxy as they cannot distinguish the real origin of the requests anymore.</p>
<p>To solve this problem on TCP connections we can make use of the <a href="https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt">proxy protocol</a>. Compared to other workarounds that exist (<code>X-Forwarded-For</code> which only works for HTTP requests or <code>Tproxy</code> that requires you to recompile your kernel) the proxy protocol:
- it is protocol agnostic (can work with any layer 7 protocols, even when encrypted).
- it does not require any infrastructure changes
- nat-ing firewalls have no impact it
- it is scalable
The is only one condition: <strong>both endpoints</strong> of the connection MUST be compatible with proxy protocol.</p>
<p>Luckily <code>dovecot</code> and <code>postfix</code> are both Proxy-Protocol ready softwares so it depends only on your used reverse-proxy/loadbalancer.</p>
<h3 id="configuration-of-the-used-proxy-software">Configuration of the used proxy software</h3>
<p>The configuration depends on the used proxy system. I will provide the configuration examples of <a href="https://traefik.io/">traefik v2</a> using IMAP and SMTP with implicit TLS. Feel free to add your configuration if you achived the same goal using different proxy software below:</p>
<details>
  <summary>traefik v2</summary>

  Truncated configuration of traefik itself:

<pre><code>version: '3.7'
services:
  reverse-proxy:
    image: traefik:v2.4
    container_name: docker-traefik
    restart: always
    command:
      - &quot;--providers.docker&quot;
      - &quot;--providers.docker.exposedbydefault=false&quot;
      - &quot;--providers.docker.network=proxy&quot;
      - &quot;--entrypoints.web.address=:80&quot;
      - &quot;--entryPoints.websecure.address=:443&quot;
      - &quot;--entryPoints.smtp.address=:25&quot;
      - &quot;--entryPoints.smtp-ssl.address=:465&quot;
      - &quot;--entryPoints.imap-ssl.address=:993&quot;
      - &quot;--entryPoints.sieve.address=:4190&quot;
    ports:
      - &quot;25:25&quot;
      - &quot;465:465&quot;
      - &quot;993:993&quot;
      - &quot;4190:4190&quot;
[...]
</code></pre>


Truncated list of neccessary labels on the mailserver container:


<pre><code>version: '2'
services:
  mail:
    image: tvial/docker-mailserver:release-v7.2.0
    restart: always
    networks:
      - proxy
    labels:
      - &quot;traefik.enable=true&quot;
      - &quot;traefik.tcp.routers.smtp.rule=HostSNI(`*`)&quot;
      - &quot;traefik.tcp.routers.smtp.entrypoints=smtp&quot;
      - &quot;traefik.tcp.routers.smtp.service=smtp&quot;
      - &quot;traefik.tcp.services.smtp.loadbalancer.server.port=25&quot;
      - &quot;traefik.tcp.services.smtp.loadbalancer.proxyProtocol.version=1&quot;
      - &quot;traefik.tcp.routers.smtp-ssl.rule=HostSNI(`*`)&quot;
      - &quot;traefik.tcp.routers.smtp-ssl.entrypoints=smtp-ssl&quot;
      - &quot;traefik.tcp.routers.smtp-ssl.service=smtp-ssl&quot;
      - &quot;traefik.tcp.services.smtp-ssl.loadbalancer.server.port=465&quot;
      - &quot;traefik.tcp.services.smtp-ssl.loadbalancer.proxyProtocol.version=1&quot;
      - &quot;traefik.tcp.routers.imap-ssl.rule=HostSNI(`*`)&quot;
      - &quot;traefik.tcp.routers.imap-ssl.entrypoints=imap-ssl&quot;
      - &quot;traefik.tcp.routers.imap-ssl.service=imap-ssl&quot;
      - &quot;traefik.tcp.services.imap-ssl.loadbalancer.server.port=10993&quot;
      - &quot;traefik.tcp.services.imap-ssl.loadbalancer.proxyProtocol.version=2&quot;
      - &quot;traefik.tcp.routers.sieve.rule=HostSNI(`*`)&quot;
      - &quot;traefik.tcp.routers.sieve.entrypoints=sieve&quot;
      - &quot;traefik.tcp.routers.sieve.service=sieve&quot;
      - &quot;traefik.tcp.services.sieve.loadbalancer.server.port=4190&quot;
[...]
</code></pre>

Keep in mind that it is neccessary to use port `10993` here. More information below at `dovecot` configuration.

</details>

<h3 id="configuration-of-the-backend-dovecot-and-postfix">Configuration of the backend (<code>dovecot</code> and <code>postfix</code>)</h3>
<p>The following changes can be achived completely by adding the content to the appropriate files by using the projects <a href="https://github.com/docker-mailserver/docker-mailserver/wiki/List-of-optional-config-files-&amp;-directories">function to overwrite config files</a>.</p>
<p>Changes for <code>postfix</code> can be applied by adding the following content to <code>config/postfix-main.cf</code>:</p>
<pre><code>postscreen_upstream_proxy_protocol = haproxy
</code></pre>
<p>and to <code>config/postfix-master.cd</code>:</p>
<pre><code>submission/inet/smtpd_upstream_proxy_protocol=haproxy
smtps/inet/smtpd_upstream_proxy_protocol=haproxy
</code></pre>
<p>Changes for <code>dovecot</code> can be applied by adding the following content to <code>config/dovecot.cf</code>:</p>
<pre><code>haproxy_trusted_networks = &lt;your-proxy-ip&gt;, &lt;optional-cidr-notation&gt;
haproxy_timeout = 3 secs
service imap-login {
  inet_listener imaps {
    haproxy = yes
    ssl = yes
    port = 10993
  }
}
</code></pre>
<p>Note that port <code>10993</code> is used here to avoid conflicts with internal systems like <code>postscreen</code> and <code>amavis</code> as they will exchange messages on the default port and obviously have a different origin then compared to the proxy.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../IPv6/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              IPv6
            </div>
          </div>
        </a>
      
      
        <a href="../Introduction/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Introduction
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy <a href="https://github.com/docker-mailserver/docker-mailserver">docker-mailserver organizaiton</a>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.f5903571.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4e3fea51.min.js"></script>
      
    
  </body>
</html>